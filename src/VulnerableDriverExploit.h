#pragma once

#include <windows.h>
#include <string>
#include <vector>

// Known vulnerable drivers for exploitation
struct VulnerableDriver {
    std::string Name;
    std::string ServiceName;
    std::string DevicePath;
    DWORD ExploitMethod;
    bool IsAvailable;
};

enum ExploitMethod {
    EXPLOIT_IOCTL = 1,
    EXPLOIT_MAP_PHYSICAL = 2,
    EXPLOIT_DKOM = 4,
    EXPLOIT_MEMORY_MAPPING = 8
};

class VulnerableDriverExploit {
public:
    VulnerableDriverExploit();
    ~VulnerableDriverExploit();

    // Driver enumeration
    std::vector<VulnerableDriver> EnumerateVulnerableDrivers();
    bool CheckDriverAvailable(const std::string& driverName);
    
    // Driver exploitation
    bool ExploitIntelPPM();
    bool ExploitAWEAlloc();
    bool ExploitMSIAfterburner();
    bool ExploitGenericDriver(const VulnerableDriver& driver);
    
    // Memory operations via vulnerable driver
    bool ReadMemoryViaExploit(ULONG_PTR address, PVOID buffer, SIZE_T size);
    bool WriteMemoryViaExploit(ULONG_PTR address, const PVOID buffer, SIZE_T size);
    bool MapPhysicalMemory(ULONG_PTR physicalAddress, SIZE_T size, PVOID* virtualAddress);
    
    // Process operations
    bool AttachToProcess(DWORD processId);
    bool GetProcessBaseAddress(DWORD processId, ULONG_PTR* baseAddress);
    
    // Driver management
    bool LoadDriver(const std::string& driverPath);
    bool UnloadDriver();
    bool IsDriverLoaded() const { return m_DriverHandle != INVALID_HANDLE_VALUE; }

private:
    HANDLE m_DriverHandle;
    DWORD m_AttachedProcessId;
    
    // Known vulnerable drivers
    std::vector<VulnerableDriver> m_KnownDrivers;
    
    // IOCTL codes for vulnerable drivers (examples)
    struct DriverIOCTL {
        std::string driverName;
        DWORD readMemoryIoctl;
        DWORD writeMemoryIoctl;
        DWORD mapPhysicalIoctl;
    };
    
    std::vector<DriverIOCTL> GetKnownIOCTLs();
    
    // Helper functions
    bool SendIoctl(DWORD ioctlCode, PVOID inputBuffer, DWORD inputSize,
                   PVOID outputBuffer, DWORD outputSize, PDWORD bytesReturned);
    bool OpenDriver(const std::string& devicePath);
    void CloseDriver();
};
